<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Reader</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- עברית רכה + אנגלית כתב-יד -->
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Patrick+Hand&family=Heebo:wght@300;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --paper:#f8f3e7; --ink:#2b2623; --line:#e7dfcf; --pill:#f0eadf;
    }
    html,body{height:100%;}
    body{
      margin:0;color:var(--ink);
      background:
        repeating-linear-gradient(#0000 0 36px,var(--line) 36px 37px),
        radial-gradient(1200px 500px at 50% -200px,#fff8ef,#f5eee2 55%,#efe6d7);
      font-family:'Heebo',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      line-height:1.75;
    }
    /* טייפוגראפיה: אנגלית כתב-יד; עברית עגול ונוסטלגי */
    body, .body{font-size:17px}
    h1,h2,.title{font-family:'Patrick Hand',cursive;}
    *:lang(he){font-family:'Varela Round','Heebo',sans-serif;}
    .wrap{max-width:940px;margin:0 auto;padding:22px;position:relative}
    .back{position:fixed;top:12px;inset-inline-start:12px;z-index:3}
    .back a{background:#2c2a27;color:#fff;text-decoration:none;border-radius:999px;padding:8px 12px;font-weight:600}
    header{text-align:center;margin:6px 0 12px}
    h1{margin:0;font-size:clamp(30px,6.4vw,58px);letter-spacing:.06em}
    .meta-top{margin-top:4px;color:#6a645d;font-weight:600}

    /* אזור העמודים – גלילה אופקית עם Snap */
    .pages{
      display:flex;gap:18px;overflow-x:auto;scroll-snap-type:x mandatory;
      padding:6px 0 16px;scroll-behavior:smooth;
    }
    .page{
      scroll-snap-align:start;flex:0 0 100%;
      background:linear-gradient(#fffdf9,#fbf3e6);
      border:1px solid #e8dfcf;border-radius:16px;
      box-shadow:0 2px 0 #e6dccd, 0 10px 24px rgba(0,0,0,.06);
      padding:18px 18px 8px;max-height:75vh;overflow-y:auto;
    }
    .meta{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 8px}
    .pill{background:var(--pill);border:1px solid #e7dfcf;border-radius:999px;padding:2px 10px;font-size:13px}
    .body{white-space:pre-wrap}
    .body img{display:block;max-width:100%;height:auto;border-radius:10px;border:1px solid #e8dfcf;box-shadow:0 1px 0 #e6dccd,0 8px 18px rgba(0,0,0,.05);margin:10px auto}
    .star-hr{display:flex;align-items:center;gap:10px;color:#8b8176;margin:14px 0 6px}
    .star-hr:before,.star-hr:after{content:"";flex:1;height:1px;background:#e0d7c6}
    .star{font-size:18px}

    /* ניווט ומונה עמודים */
    .nav{
      position:sticky;bottom:-6px;left:0;right:0;margin-top:8px;
      display:flex;align-items:center;gap:10px;justify-content:center;z-index:2;
    }
    .btn{
      background:#2c2a27;color:#fff;border:0;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;
    }
    .pager{font-weight:700;color:#5f594f;min-width:74px;text-align:center}
    .bar{height:4px;background:#e7dfcf;border-radius:999px;overflow:hidden;flex:1;max-width:380px}
    .bar>i{display:block;height:100%;width:0;background:#2c2a27}

    footer{margin:24px 0 6px;text-align:center;color:#847d71;font-size:13px}

    @media (prefers-color-scheme: dark){
      body{color:#eee}
      .page{background:linear-gradient(#2b2927,#272421);border-color:#38332c}
      .body img{border-color:#3a342d}
      .pill{background:#3a352f;border-color:#4a433a;color:#e7e0d6}
      .star-hr:before,.star-hr:after{background:#4a433a}
      .back a,.btn{background:#444}
      .bar{background:#3a352f}.bar>i{background:#ddd}
    }
  </style>
</head>
<body>
  <div class="back"><a href="index.html">← חזרה</a></div>

  <div class="wrap">
    <header>
      <h1 id="title" lang="he">ספר</h1>
      <div id="subtitle" class="meta-top" lang="he"></div>
    </header>

    <div id="pages" class="pages" aria-live="polite"></div>

    <div class="nav">
      <button id="prev" class="btn" aria-label="לעמוד הקודם">◀︎</button>
      <div class="pager" id="pager">1/1</div>
      <button id="next" class="btn" aria-label="לעמוד הבא">▶︎</button>
      <div class="bar"><i id="prog"></i></div>
    </div>

    <footer id="foot"></footer>
  </div>

  <script>
    // -------- parameters --------
    const q = new URLSearchParams(location.search);
    const slug   = q.get('book');
    const TXT_URL = slug ? `books/${slug}/book.txt` : null;
    const IMG_DIR = slug ? `books/${slug}/images/` : null;
    const IMG_EXTS = ['.jpg','.jpeg','.png','.webp'];

    // -------- helpers --------
    function setTitleFromSlug(){
      if(!slug) return;
      const pretty = slug.replace(/[-_]+/g,' ').replace(/\b\w/g,m=>m.toUpperCase());
      const el = document.getElementById('title');
      el.textContent = pretty;
      document.title = pretty + ' • Reader';
    }
    async function headExists(url){
      try{ const r = await fetch(url,{method:'HEAD',cache:'no-store'}); return r.ok; }
      catch(e){ return false; }
    }
    async function findImageSrc(base){
      for(const ext of IMG_EXTS){ const url = base+ext; if(await headExists(url)) return url; }
      return null;
    }

    // -------- rendering --------
    (async function init(){
      setTitleFromSlug();
      const container = document.getElementById('pages');
      const pager = document.getElementById('pager');
      const prog  = document.getElementById('prog');
      const sub   = document.getElementById('subtitle');

      if(!TXT_URL){ container.innerHTML='<div class="page"><div class="body">לא נבחר ספר.</div></div>'; return; }

      const res = await fetch(TXT_URL,{cache:'no-store'});
      if(!res.ok){ container.innerHTML='<div class="page"><div class="body">שגיאה בטעינת הספר.</div></div>'; return; }
      let raw = await res.text();

      // תמונות {image-N}
      const jobs = [];
      raw = raw.replace(/\{image-(\d+)\}/g,(m,n)=>{
        const ph = `@@IMG_${n}@@`;
        jobs.push((async ()=>{
          const base = IMG_DIR + `image-${n}`;
          const src  = await findImageSrc(base);
          return { ph, html: src ? `<img src="${src}" alt="image-${n}">`
                                 : `<div class="pill">תמונה חסרה image-${n}</div>` };
        })());
        return ph;
      });
      const results = await Promise.all(jobs);
      let hydrated = raw;
      for(const r of results) hydrated = hydrated.replaceAll(r.ph, r.html);

      // פיצול לעמודים לפי ********
      const parts = hydrated.split(/\r?\n\*{8,}\r?\n/).map(s=>s.trim()).filter(Boolean);

      let firstPlace='', firstDate='';
      container.innerHTML='';
      parts.forEach((part,idx)=>{
        let place=null, date=null, body=part;
        body = body.replace(/^(Place:\s*)(.+)\s*\r?\n/i,(_,p,v)=>{ place=v.trim(); return ''});
        body = body.replace(/^(Date:\s*)(.+)\s*\r?\n/i, (_,p,v)=>{ date =v.trim(); return ''});

        if(idx===0){ firstPlace=place||''; firstDate=date||''; }

        body = body.replace(/\r?\n\*\r?\n/g,'\n@@STAR@@\n').trim();

        const page = document.createElement('article'); page.className='page';

        if(place || date){
          const meta = document.createElement('div'); meta.className='meta';
          if(place){ const s=document.createElement('span'); s.className='pill'; s.textContent=`Place: ${place}`; meta.appendChild(s); }
          if(date){  const s=document.createElement('span'); s.className='pill'; s.textContent=`Date: ${date}`;  meta.appendChild(s); }
          page.appendChild(meta);
        }
        const bodyDiv = document.createElement('div'); bodyDiv.className='body';
        body.split('@@STAR@@').forEach((chunk,i)=>{
          if(i>0){ const hr=document.createElement('div'); hr.className='star-hr'; hr.innerHTML='<span class="star">★</span>'; bodyDiv.appendChild(hr); }
          const span=document.createElement('span'); span.innerHTML=chunk; bodyDiv.appendChild(span);
        });
        container.appendChild(page);
      });

      // כותרת משנה
      const bits=[]; if(firstPlace) bits.push(`מקום: ${firstPlace}`); if(firstDate) bits.push(`תאריך: ${firstDate}`);
      sub.textContent = bits.join(' • ');

      // -------- paging UX --------
      const pages = Array.from(container.children);
      const total = pages.length;
      const snapW = ()=>container.clientWidth + 18; // כולל gap
      function indexFromScroll(){
        const i = Math.round(container.scrollLeft / snapW());
        return Math.min(Math.max(i,0), total-1);
      }
      function updatePager(){
        const i = indexFromScroll();
        pager.textContent = `${i+1}/${total}`;
        prog.style.width = `${((i+1)/total)*100}%`;
      }
      updatePager();

      container.addEventListener('scroll', ()=>{ requestAnimationFrame(updatePager); }, {passive:true});

      document.getElementById('prev').onclick = ()=> container.scrollBy({left:-snapW(),behavior:'smooth'});
      document.getElementById('next').onclick = ()=> container.scrollBy({left:+snapW(),behavior:'smooth'});

      window.addEventListener('resize', updatePager);
    })();
  </script>
</body>
</html>